<template>
    <!-- Loading State - Checking Feature Access -->
    <template if:true={isCheckingAccess}>
        <div class="slds-align_absolute-center" style="height: 200px;">
            <lightning-spinner alternative-text="Checking access" size="medium"></lightning-spinner>
        </div>
    </template>

    <!-- Access Granted - Show Main Content -->
    <template if:true={hasAccess}>
    <div class={mainContainerClass}>
        <!-- Selection Phase -->
        <div class="selection-phase">
            <div class="slds-m-bottom_small">
                <div class="slds-page-header">
                    <div class="slds-page-header__row">
                        <div class="slds-page-header__col-title">
                            <div class="slds-media">
                                <div class="slds-media__figure">
                                    <lightning-icon icon-name="standard:user_role" size="medium"></lightning-icon>
                                </div>
                                <div class="slds-media__body">
                                    <div class="slds-page-header__name">
                                        <div class="slds-page-header__name-title">
                                            <h1>
                                                <span class="slds-page-header__title slds-truncate" title="Permissions Exporter">Permissions Exporter</span>
                                            </h1>
                                        </div>
                                    </div>
                                    <p class="slds-page-header__name-meta">
                                        <a href="https://help.salesforce.com/s/articleView?id=sf.perm_sets_overview.htm&type=5" target="_blank">Documentation</a>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="slds-page-header__col-actions">
                            <div class="slds-page-header__controls">
                                <div class="slds-page-header__control">
                                    <lightning-button-group>
                                        <lightning-button label="Reset" icon-name="utility:refresh" variant="neutral" onclick={handleResetSelections}></lightning-button>
                                        <lightning-button label="Export" variant="brand" icon-name="utility:download" onclick={handleExport} disabled={isExportDisabled}></lightning-button>
                                    </lightning-button-group>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="slds-tabs_default">
                <ul class="slds-tabs_default__nav" role="tablist">
                    <li class={objectsPanelClass} title="Object Permissions" role="presentation">
                        <a class="slds-tabs_default__link" href="javascript:void(0);" 
                           role="tab" 
                           tabindex="0" 
                           aria-selected={objectsPanelAriaSelected} 
                           aria-controls="tab-objects" 
                           id="tab-objects__item"
                           data-panel="objects"
                           onclick={handlePanelChange}>
                            Object Permissions
                        </a>
                    </li>
                   <!-- --><li class={systemPermissionsPanelClass} title="System Permissions" role="presentation">
                        <a class="slds-tabs_default__link" href="javascript:void(0);" 
                           role="tab" 
                           tabindex="-1" 
                           aria-selected={systemPermissionsPanelAriaSelected} 
                           aria-controls="tab-systemPermissions" 
                           id="tab-systemPermissions__item"
                           data-panel="systemPermissions"
                           onclick={handlePanelChange}>
                            System Permissions
                        </a>
                    </li>
                </ul>
                
                <!-- Object Permissions Panel Content -->
                <div id="tab-objects" class={objectsPanelContentClass} 
                     role="tabpanel" 
                     aria-labelledby="tab-objects__item">
                    <div class="slds-grid slds-gutters slds-wrap slds-m-bottom_medium">
                        <!-- Profiles Panel -->
                        <div class="slds-col slds-size_1-of-3">
                            <c-selection-panel
                                title="Profiles"
                                items={profiles}
                                enable-virtual-scrolling={enableVirtualization}
                                items-per-page="500"
                                onselectionchange={handleProfileSelectionChange}>
                            </c-selection-panel>
                        </div>
                        
                        <!-- Permission Sets Panel -->
                        <div class="slds-col slds-size_1-of-3">
                            <c-selection-panel
                                title="Permission Sets"
                                items={permissionSets}
                                enable-virtual-scrolling={enableVirtualization}
                                items-per-page="500"
                                onselectionchange={handlePermSetSelectionChange}>
                            </c-selection-panel>
                        </div>
                        
                        <!-- Objects Panel -->
                        <div class="slds-col slds-size_1-of-3">
                            <template if:false={areObjectsLoaded}>
                                <div class="slds-text-align_center slds-p-vertical_medium">
                                    <div class="slds-box slds-theme_info slds-text-align_center">
                                        <lightning-icon icon-name="utility:info" size="small" class="slds-m-right_small"></lightning-icon>
                                        <div class="slds-text-body_small">
                                            <div class="slds-text-heading_small slds-m-bottom_x-small">Objects Not Loaded</div>
                                            <div>Click the "Object Permissions" tab to load objects</div>
                                            <div class="slds-text-color_weak slds-m-top_x-small">(Performance optimization for large orgs)</div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <c-selection-panel
                                title="Objects"
                                items={objects}
                                enable-virtual-scrolling={enableVirtualization}
                                items-per-page="500"
                                is-loading={isObjectsLoading}
                                onselectionchange={handleObjectSelectionChange}>
                            </c-selection-panel>
                        </div>
                    </div>
                    
                    <div class="slds-text-align_center slds-m-vertical_medium slds-m-horizontal_xx-large">
                        <div class="slds-box slds-theme_info">
                            <p>Select at least one profile or permission set and one object to export permissions, then click Export.</p>
                        </div>
                    </div>
                    
                    <div class="slds-m-top_medium">
                        <div class="slds-card">
                            <div class="slds-card__header slds-grid">
                                <header class="slds-media slds-media_center slds-has-flexi-truncate">
                                    <div class="slds-media__figure">
                                        <lightning-icon icon-name="utility:download" size="small"></lightning-icon>
                                    </div>
                                    <div class="slds-media__body">
                                        <h2 class="slds-card__header-title">
                                            <span>Export Information</span>
                                        </h2>
                                    </div>
                                </header>
                            </div>
                            <div class="slds-card__body slds-card__body_inner">
                                <p class="slds-m-bottom_small">When you click Export, the following CSV files will be generated:</p>
                                <ul class="slds-list_dotted slds-m-top_small">
                                    <li><strong>Object Permissions Export</strong>: Contains Read, Create, Edit, Delete, View All, and Modify All permissions for selected objects and profiles/permission sets</li>
                                    <li><strong>Tab Visibility Export</strong>: Contains tab visibility settings for each profile and permission set</li>
                                    <li><strong>Field Permissions Export</strong>: Contains Read and Edit permissions for all fields in the selected objects</li>
                                </ul>
                                <p class="slds-m-top_medium">Each file will be downloaded separately to your computer. The exported permissions contain fixed columns to make scrolling easier.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!--  -->
                <div id="tab-systemPermissions" class={systemPermissionsPanelContentClass} 
                     role="tabpanel" 
                     aria-labelledby="tab-systemPermissions__item">
                     <div class="slds-text-align_center slds-m-vertical_medium slds-m-horizontal_xx-large">
                        <div class="slds-box slds-theme_info">
                            <p>Select a system permission to analyze which profiles, permission sets, and users have this permission.</p>
                        </div>
                    </div>
                    <div class="slds-grid slds-wrap slds-m-bottom_medium">
                        <!-- System Permissions Panel -->
                        <div class="slds-col slds-size_1-of-1">
                            <c-system-permissions-panel
                                onpermissionselect={handleSystemPermissionSelect}>
                            </c-system-permissions-panel>
                        </div>
                    </div>
                    
                    
                    
                    <div class="slds-m-top_medium">
                        <div class="slds-card">
                            <div class="slds-card__header slds-grid">
                                <header class="slds-media slds-media_center slds-has-flexi-truncate">
                                    <div class="slds-media__figure">
                                        <lightning-icon icon-name="utility:info" size="small"></lightning-icon>
                                    </div>
                                    <div class="slds-media__body">
                                        <h2 class="slds-card__header-title">
                                            <span>System Permissions Information</span>
                                        </h2>
                                    </div>
                                </header>
                            </div>
                            <div class="slds-card__body slds-card__body_inner">
                                <p class="slds-m-bottom_small">System permissions control access to features and operations across the entire Salesforce platform.</p>
                                <ul class="slds-list_dotted slds-m-top_small">
                                    <li><strong>Common System Permissions</strong>: Modify All Data, View All Data, Customize Application, Manage Users, Author Apex, etc.</li>
                                    <li><strong>Permission Source Analysis</strong>: See which profiles, permission sets, and permission set groups grant each permission</li>
                                    <li><strong>User Analysis</strong>: Identify all users who have a particular system permission through any source</li>
                                </ul>
                                <p class="slds-m-top_medium">Use this tool to audit who has access to critical system permissions.</p>
                                <div class="slds-grid slds-grid_align-center slds-m-top_medium">
                                    <p class="slds-text-color_success slds-text-body_small">Note: Time for exporting excel will vary depending on the number of system permissions and profiles/permission sets.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hidden container for exported components -->
        <div class="export-container" style="display: none;"></div>
    </div>
    
    <!-- Loading Spinner -->
    <template if:true={isLoading}>
        <lightning-spinner alternative-text="Loading" size="large"></lightning-spinner>
        <div class="slds-text-align_center slds-p-around_medium loading-status">
            <p>{loadingStatusText}</p>
        </div>
    </template>
    
    <!-- Export Progress Modal -->
    <template if:true={showExportModal}>
        <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container">
                <header class="slds-modal__header">
                    <h2 id="modal-heading-01" class="slds-text-heading_medium slds-hyphenate">Export Progress</h2>
                </header>
                <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1">
                    <div class="slds-p-around_medium">
                        <p class="slds-text-align_center slds-m-bottom_medium">{exportStatusText}</p>
                        <div class="slds-grid slds-grid_align-center">
                            <div class="slds-progress-bar slds-progress-bar_circular" aria-valuemin="0" aria-valuemax="100" aria-valuenow={exportProgressValue} role="progressbar" style="width: 100%; height: 10px;">
                                <span class="slds-progress-bar__value" lwc:dom="manual"></span>
                            </div>
                        </div>
                        <p class="slds-text-align_center slds-m-top_medium">{exportDetailsText}</p>
                    </div>
                </div>
                <footer class="slds-modal__footer">
                    <lightning-button label="Cancel" variant="neutral" title="Cancel" onclick={handleCancelExport} disabled={isExportCancelDisabled}></lightning-button>
                </footer>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
    </template>
    <!-- End Access Granted Content -->

    <!-- Access Denied Message -->
    <template if:false={hasAccess}>
        <template if:false={isCheckingAccess}>
            <div class="slds-align_absolute-center" style="margin-top: 100px;">
                <div class="slds-text-align_center">
                    <lightning-icon icon-name="utility:lock" size="large" class="slds-m-bottom_medium"></lightning-icon>
                    <h1 class="slds-text-heading_large slds-text-color_error slds-m-bottom_medium">
                        Sorry, you do not have access to Bulk Exporter.
                    </h1>
                    <p class="slds-text-body_regular slds-m-bottom_small">
                        It looks like your current subscription does not include access to Bulk Exporter.
                    </p>
                    <p class="slds-text-body_regular slds-m-bottom_medium">
                        To gain access, please purchase the feature by contacting our support team or visiting 
                        <a href="https://applicationperfection.com/contact/" target="_blank" class="slds-text-link">ApplicationPerfection.com</a>.
                    </p>
                    <p class="slds-text-body_small">
                        If you believe you should have access, please reach out to support for assistance.
                    </p>
                </div>
            </div>
        </template>
    </template>
</template>